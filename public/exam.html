<script>
  const socket = io();
  const urlParams = new URLSearchParams(window.location.search);
  const formUrl = urlParams.get('form');
  const duration = urlParams.get('time') || 10; 
  
  // ইউনিক এক্সাম আইডি এবং স্টুডেন্ট আইডি জেনারেট (ট্র্যাকিংয়ের জন্য)
  const examId = urlParams.get('examId') || "EXAM_" + Math.floor(Math.random() * 1000); 
  const studentName = "Student_" + Math.floor(Math.random() * 100);

  // ১. ডাইনামিকলি ফর্ম এবং টাইম সেটআপ
  if (formUrl) {
    document.getElementById('googleForm').src = decodeURIComponent(formUrl);
    socket.emit('startExam', { examId, duration: parseInt(duration) });
  } else {
    alert("No Exam Link Found!");
  }

  // ২. রিয়েল-টাইম টাইমার আপডেট
  socket.on('timerUpdate', (timeLeft) => {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    document.getElementById('timer').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
    
    if(timeLeft < 60) {
      document.getElementById('timer').style.animation = "blink 1s infinite";
    }
  });

  // ৩. প্রো-লেভেল অটো সাবমিট (Universal Logic)
  socket.on('forceSubmit', () => {
    console.log("Auto-submitting responses...");
    const iframe = document.getElementById('googleForm');
    let currentSrc = iframe.src;

    // ফর্ম লিঙ্ক থেকে /viewform ফেলে দিয়ে /formResponse যোগ করে সাবমিট ট্রিগার করা
    if (currentSrc.includes('/viewform')) {
        let submitUrl = currentSrc.replace('/viewform', '/formResponse');
        iframe.src = submitUrl + "?embedded=true&entry.status=auto-submitted"; 
    }

    // ৩ সেকেন্ড পর স্ক্রিন ব্লক করে দেওয়া
    setTimeout(() => {
        iframe.style.display = "none";
        document.getElementById('blocker').style.display = "block";
    }, 3000);
  });

  // ৪. ট্যাব সুইচ ট্র্যাকিং (টিচারের ড্যাশবোর্ডে সাইলেন্টলি রিপোর্ট যাবে)
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      socket.emit('recordViolation', { examId, studentName });
    }
  });

  // ৫. কপি-পেস্ট এবং রাইট ক্লিক লক
  window.addEventListener('keydown', (e) => {
    if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'u' || e.key === 's')) {
      e.preventDefault();
      alert("This action is restricted!");
    }
  });
</script>
